<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>爬取武生院教务处通知</title>
    <url>/2020/08/10/posts/wsy-crawler.html/</url>
    <content><![CDATA[<p>记录一下之前因为某些特殊原因而要去爬取武生院网站通知的代码，防止后面有别的需要而忘记使用方法。</p>
<a id="more"></a>

<h2 id="1-Jsoup介绍"><a href="#1-Jsoup介绍" class="headerlink" title="1.Jsoup介绍"></a>1.Jsoup介绍</h2><p>jsoup 是一款Java 的HTML解析器，可直接解析某个URL地址、HTML文本内容。它提供了一套非常省力的API，可通过DOM，CSS以及类似于jQuery的操作方法来取出和操作数据。 –来源百度百科</p>
<h2 id="2-环境"><a href="#2-环境" class="headerlink" title="2.环境"></a>2.环境</h2><p>采用Springboot 2.3.0搭建环境</p>
<p>依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--起步依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--此为核心包 jsoup爬虫--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.jsoup<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jsoup<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="3-核心代码"><a href="#3-核心代码" class="headerlink" title="3.核心代码"></a>3.核心代码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getNotice</span><span class="params">(Integer tbodyIndex, Integer trNum)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">//获取document对象</span></span><br><span class="line">    Document document = Jsoup.connect(URL).get();</span><br><span class="line">    <span class="comment">//获取第7个tbody的内容</span></span><br><span class="line">    Elements tbody = document.select(<span class="string">&quot;tbody&quot;</span>).eq(tbodyIndex);</span><br><span class="line">    <span class="comment">//System.out.println(tbody.toString());</span></span><br><span class="line">    List&lt;Article&gt; articles = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; trNum; i++) &#123;</span><br><span class="line">        Elements tr = tbody.select(<span class="string">&quot;tr&quot;</span>).eq(i);</span><br><span class="line">        Elements td1 = tr.select(<span class="string">&quot;td&quot;</span>).eq(<span class="number">0</span>);</span><br><span class="line">        Elements td2 = tr.select(<span class="string">&quot;td&quot;</span>).eq(<span class="number">2</span>);</span><br><span class="line">        String href = URL + td1.select(<span class="string">&quot;a&quot;</span>).attr(<span class="string">&quot;href&quot;</span>);</span><br><span class="line">        <span class="keyword">int</span> index = href.indexOf(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">        <span class="comment">//截取id的数字字段</span></span><br><span class="line">        String id = href.substring(index + <span class="number">3</span>, index + <span class="number">7</span>);</span><br><span class="line">        String body = td1.select(<span class="string">&quot;a&quot;</span>).text();</span><br><span class="line">        String date = td2.text();</span><br><span class="line">        Article article = <span class="keyword">new</span> Article(Integer.parseInt(id), body, href, DateUtils.parseString2Date(date));</span><br><span class="line">        articles.add(article);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sendMessage(articles);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-1-思路"><a href="#3-1-思路" class="headerlink" title="3.1 思路"></a>3.1 思路</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Document document = Jsoup.connect(URL).get();</span><br></pre></td></tr></table></figure>

<p>这行代码能够访问指定的URL路径来获取返回的静态页面</p>
<p>通过分析得到的html可以得知我们想要的<strong>新闻通知</strong>区域在第7个tbody中</p>
<p>打印输出的tbody，可以发现数据都存放在tr标签里面，分了三个td小标签</p>
<p>我们只取我们想要的数据：</p>
<ol>
<li>第一个td里面是文章链接，不带域名的。</li>
<li>第二个td里面是文章后面的gif图片，没啥用</li>
<li>第三个td里面是日期</li>
</ol>
<p>所以我们可以使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Elements td1 = tr.select(<span class="string">&quot;td&quot;</span>).eq(<span class="number">0</span>);</span><br><span class="line">Elements td2 = tr.select(<span class="string">&quot;td&quot;</span>).eq(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>来获取链接和日期 使用Article对象来进行封装。得到文章对象之后，要做什么处理就方便了。</p>
<h3 id="tips：意外收获"><a href="#tips：意外收获" class="headerlink" title="tips：意外收获"></a>tips：意外收获</h3><p>写完之后想继续爬取其他模块的，意外的发现其他模块结构类似，只是tbody和tr值不同，所以封装成一个方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//新闻通知</span></span><br><span class="line"><span class="keyword">boolean</span> news = getNotice(<span class="number">6</span>, <span class="number">9</span>);</span><br><span class="line"><span class="comment">//教务管理</span></span><br><span class="line"><span class="keyword">boolean</span> manage = getNotice(<span class="number">11</span>, <span class="number">6</span>);</span><br><span class="line"><span class="comment">//教学研究</span></span><br><span class="line"><span class="keyword">boolean</span> research = getNotice(<span class="number">13</span>, <span class="number">6</span>);</span><br><span class="line"><span class="comment">//学籍管理</span></span><br><span class="line"><span class="keyword">boolean</span> schoolRoll = getNotice(<span class="number">15</span>, <span class="number">6</span>);</span><br><span class="line"><span class="comment">//实践教学</span></span><br><span class="line"><span class="keyword">boolean</span> practice = getNotice(<span class="number">21</span>, <span class="number">6</span>);</span><br><span class="line"><span class="comment">//质量管理</span></span><br><span class="line"><span class="keyword">boolean</span> quality = getNotice(<span class="number">23</span>, <span class="number">6</span>);</span><br><span class="line"><span class="comment">//下载专区</span></span><br><span class="line"><span class="keyword">boolean</span> download = getNotice(<span class="number">25</span>, <span class="number">6</span>);</span><br><span class="line"><span class="comment">//工作例会</span></span><br><span class="line"><span class="keyword">boolean</span> work = getNotice(<span class="number">29</span>, <span class="number">6</span>);</span><br><span class="line"><span class="comment">//考务管理</span></span><br><span class="line"><span class="keyword">boolean</span> exam = getNotice(<span class="number">31</span>, <span class="number">6</span>);</span><br><span class="line"><span class="comment">//学习动态</span></span><br><span class="line"><span class="keyword">boolean</span> study = getNotice(<span class="number">33</span>, <span class="number">6</span>);</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>crawler</category>
      </categories>
      <tags>
        <tag>crawler</tag>
      </tags>
  </entry>
  <entry>
    <title>nginx实现负载均衡</title>
    <url>/2020/08/11/posts/nginxConfig.html/</url>
    <content><![CDATA[<p>Nginx可以配置代理多台服务器，当一台服务器宕机之后，仍能保持系统可用。记录一下nginx负载均衡的实现，配置文件如下：</p>
<a id="more"></a>

<ol>
<li>在http节点下，添加upstream节点。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">upstream abc &#123; </span><br><span class="line">   server localhost:7080; </span><br><span class="line">   server localhost:8980; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将server节点下的location节点中的proxy_pass配置为：http:// + upstream名称，即</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">location &#x2F; &#123; </span><br><span class="line">    root  html; </span><br><span class="line">    &#x2F;&#x2F;http:&#x2F;&#x2F; + upstream名称</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;abc; </span><br><span class="line">    index  index.html index.htm; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>upstream按照轮询（默认）方式进行负载，每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。虽然这种方式简便、成本低廉。但缺点是：可靠性低和负载分配不均衡。适用于图片服务器集群和纯静态页面服务器集群。除此之外，upstream还有其它的分配策略，分别如下：</p>
<ol>
<li>weight（权重）</li>
</ol>
<p>指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。如下所示，10.0.0.88的访问比率要比10.0.0.77的访问比率高一倍。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">upstream linuxidc&#123; </span><br><span class="line">      server 10.0.0.77 weight&#x3D;5; </span><br><span class="line">      server 10.0.0.88 weight&#x3D;10; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>ip_hash（访问ip）</li>
</ol>
<p>每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">upstream favresin&#123; </span><br><span class="line">      ip_hash; </span><br><span class="line">      server 10.0.0.10:8080; </span><br><span class="line">      server 10.0.0.11:8080; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p>fair（第三方）</p>
<p>按后端服务器的响应时间来分配请求，响应时间短的优先分配。与weight分配策略类似。</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> upstream abc&#123;   </span><br><span class="line">   server 10.0.0.10:8080; </span><br><span class="line">   server 10.0.0.11:8080; </span><br><span class="line">   fair; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>url_hash（第三方）</li>
</ol>
<p>按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。</p>
<p>注意：在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"> upstream abc&#123; </span><br><span class="line">   server 10.0.0.10:7777; </span><br><span class="line">   server 10.0.0.11:8888; </span><br><span class="line">   hash $request_uri; </span><br><span class="line">   hash_method crc32; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>upstream还可以为每个设备设置状态值，这些状态值的含义分别如下：</p>
<p>down 表示单前的server暂时不参与负载.</p>
<p>weight 默认为1.weight越大，负载的权重就越大。</p>
<p>max_fails ：允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream 模块定义的错误.</p>
<p>fail_timeout : max_fails次失败后，暂停的时间。</p>
<p>backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">upstream bakend&#123; #定义负载均衡设备的Ip及设备状态 </span><br><span class="line"> ip_hash; </span><br><span class="line">   server 10.0.0.11:9090 down; </span><br><span class="line">   server 10.0.0.11:8080 weight&#x3D;2; </span><br><span class="line">   server 10.0.0.11:6060; </span><br><span class="line">   server 10.0.0.11:7070 backup; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>nginx</category>
      </categories>
      <tags>
        <tag>nginx</tag>
      </tags>
  </entry>
</search>
